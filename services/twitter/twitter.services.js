const Twitter = require('twitter')
require('dotenv').config()
const { convert } = require('html-to-text');

class TwitterServices{
    constructor(){
        this.twitterClient = new Twitter({
            consumer_key: process.env.TWITTER_CONSUMER_KEY,
            consumer_secret: process.env.TWITTER_CONSUMER_SECRET,
            access_token_key: process.env.TWITTER_ACCESS_TOKEN_KEY,
            access_token_secret: process.env.TWITTER_ACCESS_TOKEN_SECRET,
        });
    }

    async tweet(data){
        try{
        const images = getImgSrcFromHTML(data)
        const tweet = convert(data, {selectors: [ { selector: 'img', format: 'skip' }, { selector: 'a', format: 'skip' } ]})
        const tweetSplitArr = (tweet.match(/.{1,280}/g));

        const firstTwElement = tweetSplitArr.shift()
        const parentTweetPostReqData = await this.twitterClient.post('https://api.twitter.com/1.1/statuses/update.json', {status: firstTwElement})
        const parentId = parentTweetPostReqData.id_str

        let idToReply = parentId

        while(tweetSplitArr.length > 0){
            const twElement = tweetSplitArr.shift()
            const tweetReplyResData = await this.twitterClient.post('https://api.twitter.com/1.1/statuses/update.json', {status: twElement, in_reply_to_status_id: idToReply})
            idToReply = tweetReplyResData.id_str
        }

        return{
            success: true,
            data: parentId
        }
        }catch(e){
            console.log(e)
            return {
                success: false,
                data: e.message
            }
        }
    }

}

function getImgSrcFromHTML(html){
    const images = []
    const rex =  /<img[^>]+src="?([^"\s]+)"?\s*/gi;
    while (m = rex.exec( html )) {
        images.push( m[1] );
    }
    return images
}

// const test = new TwitterServices()
// test.tweet('<h1>TESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTESTTESTEST</h1><img src="https://www.adslzone.net/app/uploads-adslzone.net/2019/04/borrar-fondo-imagen.jpg">')

module.exports = TwitterServices